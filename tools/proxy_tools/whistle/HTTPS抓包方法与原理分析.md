# HTTPS抓包原理分析

## 一、背景

​	前几天测试预发环境（即公司内部局域网）问题，用到了第三方代理工具-whistle工具，在PC端配置了预发环境的hosts，但是whistle的web端始终抓不到https的包，而且在手机端设置代理后，也无法访问baidu主页。经开发与我的测试分析，结论是由于手机端未安装whistle的私有的数字证书导致的。由此引发了我对HTTPS抓包原理的探索。出现上述的问题，是由于自身对HTTPS的工作原理及代理工具的使用的原理认识不清楚而导致的。

​	抓包工具对于线上回归测试至关重要，是重要的分析工具，也是调试工具。经过对第三方代理工具的简单认识，从charles、fiddler、whistle中选出whistle进行研究分析，并将其运用到后续的测试工作中。

​	选whistle的原因主要在于：

​	1.whistle工具采用node实现，不需要额外安装客户端工具，利用chrome浏览器即可进行访问。

​	2.whistle支持移动端动态调试。

​	3.whistle是跨平台的。支持windows和mac。

## 二、Https运行原理分析

### 1.Https协议

```
	HTTPS(Hyper Text Transfer Protocol Secure)，是一种基于SSL/TLS的HTTP，所有的HTTP数据都是在SSL/TLS协议封装之上进行传输的。HTTPS协议是在HTTP协议的基础上，添加了SSL/TLS握手以及数据加密传输，也属于应用层协议。所以，研究HTTPS协议原理，最终就是研究SSL/TLS协议。
```

### 2.运行过程

​	实际上SSL/TLS协议的基本思路是非对称加密和对称加密结合来传输数据，**一言以弊之，HTTPS是通过一次非对称加密算法（如RSA算法）进行了协商密钥的生成与交换，然后在后续通信过程中就使用协商密钥进行对称加密通信**，之所以要使用这两种加密方式的原因在于非对称加密计算量较大，如果一直使用非对称加密来传输数据的话，会影响效率。

运行过程盗用巨人的图，可以表示如下：

<img src="https://github.com/llggpp2009/tester/blob/master/markdown_picture/whistle/https_Running_process.png?raw=true" style="zoom:67%;" />

#### 2.1.HTTPS请求

这个步骤是整个通信过程中的第一步，首先，客户端（通常是浏览器）先向服务器发出加密通信的请求，在这一步中，客户端主要向服务器提供以下信息：

- 支持的协议版本，比如TLS 1.0版
- 一个客户端生成的随机数RandomC，稍后用于生成**“协商密钥”**。
- 支持的加密方法，比如RSA公钥加密。
- 支持的压缩方法。

#### 2.2.服务器响应

服务器收到客户端请求后，向客户端发出回应，服务器的回应一般包含以下内容：

- 确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。
- 一个服务器生成的随机数RandomS，稍后用于生成“**协商密钥**”。
- 从客户端支持的加密方法中选择一个作为确认要使用的加密方法，比如RSA公钥加密。
- 服务器证书。
   这个服务器证书就是表明服务器身份的东西，其中也包含了非对称加密中需要使用的公钥。

#### 3.证书校验、生成密码、公钥加密

​	客户端收到服务器回应以后，首先验证服务器返回的证书。如果证书不是可信机构颁发，或者证书中的域名与实际域名不一致，或者证书已经过期，以浏览器为例客户端会向网页访问者显示一个警告，由其选择是否还要继续通信。 如果证书没有问题，客户端就会从证书中取出服务器的公钥。然后生成密码、公钥加密。
​	生成密码的过程会先产生一个随机数Pre-master key，该随机数是整个握手阶段出现的第三个随机数，稍后会经过公钥加密发送到服务端，有了它以后，客户端和服务器就同时有了三个随机数——RandomC，RandomS，Pre-master key，接着双方就用事先商定的加密方法，各自生成本次会话所用的同一把“**协商密钥**”。

#### 4.加密信息C-S

加密信息是指上面一步生成的内容，主要包括

- 一个随机数Pre-master key。用于给服务端生成“**协商密钥**”。
- 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
- 客户端握手结束通知，表示客户端的握手阶段已经结束。这一项通常也是前面发送的所有内容的hash值，用来供服务器校验。

#### 5.私钥解密、解密握手消息、验证Hash

​	服务器收到客户端公钥加密的第三个随机数Pre-master key之后，通过自身私钥解密该数值并由之前的RandomC和RandomS计算生成本次会话所用的“**会话密钥**”。然后，通过约定的Hash算法验证客户端发送的数据完整性。

#### 6.加密信息S-C

主要是指

- 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
- 服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发生的所有内容的hash值，用来供客户端校验。

#### 7.解密握手消息、验证Hash

客户端解密并计算握手消息的HASH，如果与服务端发来的HASH一致，此时握手过程结束。

#### 8.正常加密通信

握手成功之后，所有的通信数据将由之前"**协商密钥**"及约定好的算法进行加密解密。



## 三、代理工具抓HTTPS包的原理

​	不管什么协议代理工具，如果只是普通的HTTP请求，因为数据本身没经过再次加密，因此作为代理可以知道所有客户端发送到服务端的请求内容以及服务端返回给客户端的数据内容，这也就是抓包工具能够将数据传输内容直接展现出来的原因。对于HTTPS请求，4，6，8步骤的数据都已经经过了加密，代理如果什么都不做的话是无法获取到其中的内容的。为了实现这个过程的数据获取，代理工具需要做的事情是对客户端伪装服务端，对服务端伪装客户端，具体操作如下：

- **截获真实客户端的HTTPS请求，伪装客户端向真实服务端发送HTTPS请求**
- **接受真实服务器响应，用Charles自己的证书伪装服务端向真实客户端发送数据内容**

一般情况下HTTPS中是客户端对服务端做证书校验，当然也有一些金融机构会有用户证书作为提供给服务端做用户认证的工具，保证发出请求的的确是这部分授权用户。我们仅分析客户端对服务单做证书校验的这种。Android有自己的一套HTTPS通信调用方式，以HttpsURLConnection为例

![img](https:////upload-images.jianshu.io/upload_images/2838851-811f1c8b030f8411.png?imageMogr2/auto-orient/strip|imageView2/2/w/489/format/webp)

上面这段代码就是一个https请求的样例，这种方法的特点是证书校验工作交由系统处理，系统只会允许可信CA签发的数字证书能够访问，私有CA签发的数字证书（比如12306以及我们上文说的代理工具的证书）是无法访问的。
 那么如何绕过呢，

- 第一种方法是**修改Https通信代码**，这种只对开发者开发应用的时候好使，我们需要实现X509TrustManager接口去做自己的一套证书校验，它并不通用，尤其是对于我们抓包而言是不可行的，因为我们没法去修改别人应用中的代码。
- 第二种方法是**将私有CA签发的数字证书安装到手机中并且作为受信任证书保存**，这种方式是我们推荐的方式，唯一的缺点是你的手机上可能会在通知栏一直留着一个特殊标志，告诉你网络可能被监控。恩，不监控我们怎么抓包呢，哈哈。

基于上述原理说明，代理工具需要做的事就是：

```
将私有CA签发的数字证书安装到手机中并且作为受信任证书保存
```

## 四、中间人攻击-Main-in-the-middle attack(MITM)

### 1.定义

​	**中间人攻击是指攻击者与通讯的两端分别创建独立的联系，并交换其所收到的数据，使通讯的两端认为他们正在通过一个私密的连接与对方直接对话，但事实上整个会话都被攻击者完全控制。**

​	简单来说，攻击者在请求和响应传输途中，拦截并篡改内容。对于 HTTP 来说，由于设计的简单，不需要太多步骤就可以进行监听和修改报文；在这里主要是针对 HTTPS，HTTPS 使用了 SSL 加密协议，是一种非常安全的机制，目前并没有方法直接对这个协议进行攻击，一般都是在建立 SSL 连接时，利用中间人获取到 CA证书、非对称加密的公钥、对称加密的密钥；有了这些条件，就可以对请求和响应进行拦截和篡改。

### 2.中间人攻击需要截获请求响应

对于中间人攻击，有一个前提就是：**需要截获到客户端与服务器通信的线路**。

抓包工具一般都是用户主动将其设置成系统的网络访问代理服务器，使得所有的网络访问请求都通过它来完成，从而实现了网络封包的截取和分析。

对于其它工具则是利用 DNS欺骗、ARP投毒、劫持网关等手段，将客户端的请求重定向到攻击者的机器，以便进行网络抓包。

### 3.SSL 证书欺骗攻击

SSL 证书欺骗攻击流程大概如下：

1. 截获客户端与服务器通信的通道
2. 然后在 SSL 建立连接的时候，进行中间人攻击
3. 将自己伪装成客户端，获取到服务器真实有效的 CA 证书（**非对称加密的公钥**）
4. 将自己伪装成服务器，获取到客服端的之后通信的密钥（**对称加密的密钥**）
5. 有了**证书和密钥**就可以监听之后通信的内容了

<img src="https://github.com/llggpp2009/tester/blob/master/markdown_picture/whistle/Maninthemiddleattack.png?raw=true" style="zoom: 67%;" />

​	首先通过ARP欺骗、DNS劫持甚至网关劫持等等，将客户端的访问重定向到攻击者的机器，让客户端机器与攻击者机器建立HTTPS连接（使用伪造证书），而攻击者机器再跟服务端连接。这样用户在客户端看到的是相同域名的网站，但浏览器会提示证书不可信，用户不点击继续浏览就能避免被劫持的。所以这是最简单的攻击方式，也是最容易识别的攻击方式。

<img src="https://github.com/llggpp2009/tester/blob/master/markdown_picture/whistle/SSL_certcheat.png?raw=true" style="zoom: 50%;" />

SSL证书欺骗的避免方法就是：

- 客户端不要轻易信任证书
- App 可以提前预埋证书在本地

### 4.SSL 剥离攻击

SSL 剥离就是将客户端的 HTTPS 请求降级成 HTTP 请求，阻止 HTTP 请求重定向成 HTTPS ，假如客户端直接访问HTTPS的URL，攻击者是没办法直接进行降级的，因为HTTPS与HTTP虽然都是TCP连接，但HTTPS在传输HTTP数据之前，需要在进行了SSL握手，并协商传输密钥用来后续的加密传输；假如客户端与攻击者进行SSL握手，而攻击者无法提供可信任的证书来让客户端验证通过进行连接，所以客户端的系统会判断为SSL握手失败，断开连接。

该攻击方式主要是利用用户并不会每次都直接在浏览器上输入[https://xxx.xxx.com](https://link.jianshu.com?t=https://xxx.xxx.com) 来访问网站，或者有些网站并非全网HTTPS，而是只在需要进行敏感数据传输时才使用HTTPS的漏洞。中间人攻击者在劫持了客户端与服务端的HTTP会话后，将HTTP页面里面所有的 https:// 超链接都换成 http:// ，用户在点击相应的链接时，是使用HTTP协议来进行访问；这样，就算服务器对相应的URL只支持HTTPS链接，但中间人一样可以和服务建立HTTPS连接之后，将数据使用HTTP协议转发给客户端，实现会话劫持。

这种攻击手段更让人难以提防，因为它使用HTTP，不会让浏览器出现HTTPS证书不可信的警告，而且用户很少会去看浏览器上的URL是 https:// 还是 http:// 。特别是App的WebView中，应用一般会把URL隐藏掉，用户根本无法直接查看到URL出现异常。

流程图如下：

<img src="https://upload-images.jianshu.io/upload_images/264052-1bdd8f4f32a89179.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp" alt="img" style="zoom:50%;" />



### 5.总结

中间人攻击主要是伪装身份，然后截取通信的内容，对于 HTTP 是可以很轻松的截获；但是对于 HTTPS，主要是在建立 SSL 连接的时候，骗取到证书和密钥；

**使用WireShark模拟中间人证书伪造攻击**  [http://blog.csdn.net/phunxm/article/details/38590561](https://link.jianshu.com/?t=http://blog.csdn.net/phunxm/article/details/38590561)

**使用Charles模拟中间人证书伪造攻击** http://www.jianshu.com/p/a81b496348bc](https://www.jianshu.com/p/a81b496348bc)